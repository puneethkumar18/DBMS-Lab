-- CREATING INSURANCE DATABASE
CREATE DATABASE INSURANCE;

-- USING INSURANCE DATABASE
USE INSURANCE;

-- CREATE PERSON TABLE
CREATE TABLE PERSON(
DRIVER_ID INT PRIMARY KEY,
DNAME VARCHAR(30),
ADDRESS VARCHAR(200)
);


-- CREATE CAR TABLE
CREATE TABLE CAR(
REG_NO VARCHAR(20) PRIMARY KEY,
MODEL VARCHAR(50),
YEAR INT
);


-- CREATE ACCINDENT TABLE
CREATE TABLE ACCIDENT(
REPORT_NO INT PRIMARY KEY,
ACC_DATE DATE,
LOCATION VARCHAR(100)
);

-- CREATE OWNS TABLE
CREATE TABLE OWNS(
DRIVER_ID INT ,
REG_NO VARCHAR(20),
PRIMARY KEY(DRIVER_ID,REG_NO),
FOREIGN KEY (DRIVER_ID) REFERENCES PERSON (DRIVER_ID),
FOREIGN KEY (REG_NO) REFERENCES CAR(REG_NO)
);

-- CREATE PARTICIPATED TABELE
CREATE TABLE PARTICIPATED(
DRIVER_ID INT ,
REG_NO VARCHAR(20),
REPORT_NO INT,
DAMAGE_AMOUNT INT,
PRIMARY KEY(DRIVER_ID,REG_NO,REPORT_NO),
FOREIGN KEY(DRIVER_ID) REFERENCES PERSON(DRIVER_ID),
FOREIGN KEY(REG_NO) REFERENCES CAR(REG_NO),
FOREIGN KEY(REPORT_NO) REFERENCES ACCIDENT(REPORT_NO)
);


-- INSERT DATA INTO PERSON TABLE
INSERT INTO PERSON (DRIVER_ID,DNAME,ADDRESS)
VALUES
(101,'DRIVER 1','RANCHI'),
(102,'DRIVER 2','MUMBAI'),
(103,'DRIVER 3','KOLKATA'),
(104,'DRIVER 4','CHENNAI'),
(105,'DRIVER 5','BENGALURU');

-- INSERT DATA INTO CAR TABLE
INSERT INTO CAR(REG_NO,MODEL,YEAR)
VALUES
('R01','SEDAN','2001'),
('R02','SPORTS','2002'),
('R03','XUV','2003'),
('R04','HATCHBACK','2004'),
('R05','SUV','2005');

-- INSERT DATA INTO ACCIDENT TABLE
INSERT INTO ACCIDENT(REPORT_NO,ACC_DATE,LOCATION)
VALUES
(111,'2020-12-11','MADRASS'),
(112,'2020-12-12','MUMBAI'),
(113,'2020-12-13','KOLKATA'),
(114,'2020-12-14','MYSORE'),
(115,'2020-12-15','DELHI');


-- INSERT DATA INTO OWNS TABLE
INSERT INTO OWNS(DRIVER_ID,REG_NO)
VALUES
(101,'R01'),
(102,'R02'),
(103,'R03'),
(104,'R04'),
(105,'R05');

-- INSERT DATA INTO PARTICIAPTED TABLE
INSERT INTO PARTICIPATED (DRIVER_ID,REG_NO,REPORT_NO,DAMAGE_AMOUNT)
VALUES
(101,'R01',111,9999),
(102,'R02',112,8888),
(103,'R03',113,7777),
(104,'R04',114,6666),
(105,'R05',115,5555);

-- Find the total number of people who owned a car that were involved in accidents in 2021
SELECT COUNT(DRIVER_ID) FROM ACCIDENT A,PARTICIPATED P
WHERE A.REPORT_NO = P.REPORT_NO AND A.ACC_DATE LIKE "2020%";

-- Find the number of accident in which cars belonging to driver 1 were involved
SELECT COUNT(REPORT_NO)
FROM ACCIDENT A
WHERE EXISTS
(SELECT * FROM PARTICIPATED PTD,PERSON P WHERE
P.DRIVER_ID = PTD.DRIVER_ID AND P.DNAME = "DRIVER 1" AND
A.REPORT_NO = PTD.REPORT_NO);

-- Delete the Mazda belonging to Smith
DELETE FROM CAR
WHERE MODEL = 'SEDAN' AND REG_NO IN
(SELECT CAR.REG_NO FROM PERSON P,OWNS O
WHERE O.DRIVER_ID=P.DRIVER_ID AND CAR.REG_NO=O.REG_NO AND P.DNAME = "DRIVER 1");


-- View that shows models and years of car that are involved in accident
CREATE VIEW CARSINACCIDENT AS 
SELECT MODEL,YEAR FROM 
CAR C ,PARTICIPATED P
WHERE P.REG_NO = C.REG_NO;

SELECT * FROM CARSINACCIDENT;

-- Create a view that shows name and address of drivers who own a car.
CREATE VIEW DriversWithCar AS
SELECT DNAME ,ADDRESS FROM 
PERSON P , OWNS O
WHERE O.DRIVER_ID = P.DRIVER_ID;


SELECT * FROM DriversWithCar;

-- Create a view that shows the names of the drivers who a participated in a accident in a specific place.

CREATE VIEW DriversWithAccidentInPlace AS
SELECT DNAME FROM 
PARTICIPATED PTD,PERSON P,ACCIDENT A
WHERE A.REPORT_NO = PTD.REPORT_NO AND PTD.DRIVER_ID = P.DRIVER_ID AND A.LOCATION = "MADRASS";

SELECT * FROM DriversWithAccidentInPlace;

-- Trigger that prevents a driver with total_damage_amount greater than Rs. 50,000 from owning a car

DELIMITER //
CREATE TRIGGER PreventOwnership
BEFORE INSERT ON OWNS
FOR EACH ROW
BEGIN 
IF NEW.DRIVER_ID IN (SELECT DRIVER_ID FROM PARTICIPATED GROUP BY DRIVER_ID HAVING MAX(DAMAGE_AMOUNT) >= 50000) THEN
SIGNAL SQLSTATE '43000' SET MESSAGE_TEXT = 'DAMAGE GREATER THAN 50000';
END IF;
END;
DELIMITER;


DROP TRIGGER PreventOwnership;

INSERT INTO OWNS VALUES
(101,'R06');

-- A trigger that prevents a driver from participating in more than 2 accidents in a given year.
DELIMITER //
CREATE TRIGGER PreventParticipation
BEFORE INSERT ON PARTICIPATED
FOR EACH ROW
BEGIN
IF 2<=(SELECT COUNT(DRIVER_ID) FROM PARTICIPATED P WHERE P.DRIVER_ID = NEW.DRIVER_ID) THEN
SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = "HIGHEST PARTCIPATE";
END IF;
END;
DELIMITER;

INERT INTO PARTICIPATED VALUES
(105,'R05',115,5555);